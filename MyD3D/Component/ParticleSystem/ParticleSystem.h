#pragma once
#include "Component/Component.h"

#define maxParticleCount 3000


class Texture2D;

class ParticleSystem : public RendererComponent
{
public:
	explicit ParticleSystem(Object* _owner);
	virtual ~ParticleSystem();
public:
	virtual void Start();
	virtual void Tick();
	virtual void FixedUpdate();
	virtual void PreUpdate();
	virtual void Update();
	virtual void PostUpdate();
	virtual void PreRender();
	virtual void Render();
	virtual void Draw(Camera* _camera);
	virtual void PostRender();
	// Editor Only
	virtual void EditorUpdate();
	virtual void EditorRender();

public:
	virtual json Serialize();
	virtual void Deserialize(json& j);

public:
	virtual void EditorRendering(EditorViewerType _viewerType) override;

public:
	virtual void DrawMesh(Matrix& _view, Matrix& _projection);
	virtual void DrawShadow(Light* _pLight);
public:
	virtual void SetMesh(ResourceHandle _handle) {}
	virtual void SetMaterial(ResourceHandle _handle) {}
	virtual std::shared_ptr<MeshResource> GetMesh() { return nullptr; }
	virtual Material* GetMaterial() { return nullptr; }

private:
	//Init Or Renew
	void SetMaterial();
	void SetBuffers();
	void DefaultFogMove();

	//Update
	void FromBufferToGPU();
	void FromGPUToBuffer();
private:
	unsigned int mParticleCount = 100;

	PxPBDParticleSystem* mParticleSystem;
	PxParticleBuffer* mParticleBuffer;
	PxVec4 mPositionsHost[maxParticleCount];
	PxVec4 mVelocitiesHost[maxParticleCount];
	PxU32 mPhasesHost[maxParticleCount];

	//PBDMaterial
	PxPBDMaterial* mMaterial;
	float mFriction = 0.1f;           // 마찰 계수
	float mDamping = 0.05f;           // 감쇠 계수
	float mAdhesion = 0.0f;           // 접착력
	float mViscosity = 0.01f;         // 점성
	float mVorticity = 0.9f;          // 소용돌이 강도
	float mSurfaceTension = 0.1f;     // 표면 장력
	float mCohesion = 0.7f;           // 결합력
	float mBuoyancy = 0.5f;           // 상승력
	float mAirResistance = 0.1f;      // 공기 저항
	float mCflCoefficient = 1.0f;     // CFL 계수
	float mGravity = 0.0f;            // 중력

	std::shared_ptr<Texture2D>  mTexture;
	int mTextureSize = 5;

	class D3DGraphicsVertexBuffer* mVertexBuffer{};
};

